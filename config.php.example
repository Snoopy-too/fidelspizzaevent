<?php
// config.php.example - Database and application configuration template
//
// INSTRUCTIONS:
// 1. Copy this file to config.php: cp config.php.example config.php
// 2. Update the values below with your actual database credentials and settings
// 3. Make sure config.php is in .gitignore (it is) to avoid committing sensitive data
//

// Database configuration
define('DB_HOST', 'your-database-host');        // e.g., localhost or your Bluehost MySQL host
define('DB_USER', 'your-database-username');    // e.g., your Bluehost MySQL username
define('DB_PASS', 'your-database-password');    // Your database password
define('DB_NAME', 'your-database-name');        // e.g., your_cpanel_username_fidels_pizza

// Application configuration
define('SITE_URL', 'https://yoursite.com');     // Change to your domain
define('ADMIN_SESSION_TIMEOUT', 3600);          // 1 hour
define('USER_SESSION_TIMEOUT', 7200);           // 2 hours

// Email configuration (for shared hosting, usually use mail() function)
define('FROM_EMAIL', 'noreply@yoursite.com');   // Your email address
define('FROM_NAME', 'Fidel\'s Pizza Event');    // Your site name

// Define ROOT_PATH
define('ROOT_PATH', __DIR__);

// Start session
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// Language handling
if (isset($_GET['lang']) && in_array($_GET['lang'], ['ja', 'en'])) {
    $_SESSION['lang'] = $_GET['lang'];
}

if (!isset($_SESSION['lang'])) {
    $_SESSION['lang'] = 'ja'; // Default language
}

// Load language file
$lang_code = $_SESSION['lang'];
$translations = require __DIR__ . "/languages/{$lang_code}.php";

function __($key) {
    global $translations;
    return $translations[$key] ?? $key;
}

// Database connection
function getDB() {
    static $pdo = null;
    if ($pdo === null) {
        try {
            $pdo = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4",
                          DB_USER, DB_PASS, [
                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
            ]);
        } catch (PDOException $e) {
            die("Database connection failed: " . $e->getMessage());
        }
    }
    return $pdo;
}

// Security settings

function sanitize($text) {
    return htmlspecialchars($text, ENT_QUOTES, 'UTF-8');
}

function generateToken($length = 32) {
    return bin2hex(random_bytes($length / 2));
}

function generateOrderNumber() {
    return 'PZ' . date('Y') . str_pad(mt_rand(1, 9999), 4, '0', STR_PAD_LEFT);
}

function hashPassword($password) {
    return password_hash($password, PASSWORD_DEFAULT, ['cost' => 10]);
}

function verifyPassword($password, $hash) {
    return password_verify($password, $hash);
}

function isLoggedIn() {
    return isset($_SESSION['user_id']) || isset($_SESSION['admin_id']);
}

function isAdmin() {
    return isset($_SESSION['admin_id']);
}

function requireLogin() {
    if (!isLoggedIn()) {
        header('Location: login.php');
        exit;
    }
}

function requireAdmin() {
    if (!isAdmin()) {
        header('Location: admin_login.php');
        exit;
    }
}

function redirect($url) {
    header("Location: $url");
    exit;
}

function formatPrice($price) {
    return 'Â¥' . number_format($price, 0);
}

function sendEmail($to, $subject, $body, $headers = '') {
    if (!$headers) {
        $headers = "From: " . FROM_NAME . " <" . FROM_EMAIL . ">\r\n";
        $headers .= "Reply-To: " . FROM_EMAIL . "\r\n";
        $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";
    }
    return mail($to, $subject, $body, $headers);
}

function getEmailTemplate($template_name) {
    $db = getDB();
    $stmt = $db->prepare("SELECT subject, body FROM email_templates WHERE template_name = ?");
    $stmt->execute([$template_name]);
    return $stmt->fetch();
}

function replacePlaceholders($text, $placeholders) {
    foreach ($placeholders as $key => $value) {
        $text = str_replace('{{' . $key . '}}', $value, $text);
    }
    return $text;
}

function getSiteConfig() {
    static $config = null;
    if ($config === null) {
        $db = getDB();
        $stmt = $db->query("SELECT * FROM site_config ORDER BY id DESC LIMIT 1");
        $config = $stmt->fetch() ?: [];
    }
    return $config;
}

function uploadImage($file, $directory = 'uploads/') {
    if (!file_exists($directory)) {
        mkdir($directory, 0755, true);
    }

    $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
    $allowed_extensions = ['jpg', 'jpeg', 'png', 'gif'];
    if (!in_array($extension, $allowed_extensions)) {
        throw new Exception('Invalid file type');
    }

    if ($file['size'] > 5000000) { // 5MB
        throw new Exception('File too large');
    }

    $filename = uniqid() . '.' . $extension;
    $filepath = $directory . $filename;

    if (move_uploaded_file($file['tmp_name'], $filepath)) {
        return $filepath;
    } else {
        throw new Exception('Upload failed');
    }
}

/**
 * Handle image upload for menu items
 * @param string $fileInputName The name of the file input field
 * @param string|null $existingImagePath The existing image path (if updating)
 * @return string|null The path to the uploaded image or existing image
 */
function handleImageUpload($fileInputName, $existingImagePath = null) {
    // Check if a file was uploaded
    if (isset($_FILES[$fileInputName]) && $_FILES[$fileInputName]['error'] === UPLOAD_ERR_OK) {
        $file = $_FILES[$fileInputName];

        // Validate file type
        $allowed_types = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mime_type = finfo_file($finfo, $file['tmp_name']);
        finfo_close($finfo);

        if (!in_array($mime_type, $allowed_types)) {
            throw new Exception('Invalid file type. Only JPG, PNG, and GIF images are allowed.');
        }

        // Validate file size (5MB max)
        if ($file['size'] > 5 * 1024 * 1024) {
            throw new Exception('File size too large. Maximum size is 5MB.');
        }

        // Create images directory if it doesn't exist
        $upload_dir = ROOT_PATH . DIRECTORY_SEPARATOR . 'images';
        if (!file_exists($upload_dir)) {
            mkdir($upload_dir, 0755, true);
        }

        // Generate unique filename
        $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
        $filename = uniqid('menu_') . '.' . $extension;
        $filepath = $upload_dir . DIRECTORY_SEPARATOR . $filename;

        // Move uploaded file
        if (move_uploaded_file($file['tmp_name'], $filepath)) {
            // Delete old image if it exists and is different
            if ($existingImagePath && file_exists(ROOT_PATH . DIRECTORY_SEPARATOR . $existingImagePath)) {
                $old_file = ROOT_PATH . DIRECTORY_SEPARATOR . $existingImagePath;
                if (is_file($old_file)) {
                    @unlink($old_file);
                }
            }

            // Return relative path for database storage
            return 'images/' . $filename;
        } else {
            throw new Exception('Failed to upload image.');
        }
    } elseif (isset($_FILES[$fileInputName]) && $_FILES[$fileInputName]['error'] !== UPLOAD_ERR_NO_FILE) {
        // An error occurred during upload
        $error_messages = [
            UPLOAD_ERR_INI_SIZE => 'File exceeds upload_max_filesize directive in php.ini',
            UPLOAD_ERR_FORM_SIZE => 'File exceeds MAX_FILE_SIZE directive in HTML form',
            UPLOAD_ERR_PARTIAL => 'File was only partially uploaded',
            UPLOAD_ERR_NO_TMP_DIR => 'Missing temporary folder',
            UPLOAD_ERR_CANT_WRITE => 'Failed to write file to disk',
            UPLOAD_ERR_EXTENSION => 'File upload stopped by extension'
        ];
        $error_code = $_FILES[$fileInputName]['error'];
        $error_msg = $error_messages[$error_code] ?? 'Unknown upload error';
        throw new Exception('Upload error: ' . $error_msg);
    }

    // No new file uploaded, return existing path
    return $existingImagePath;
}

/**
 * Sends order confirmation/update emails to both the customer and the admin.
 * @param int $order_id The ID of the order.
 * @param bool $isUpdate Set to true if this is an order update notification.
 * @return bool Returns true if the email was successfully sent to the customer.
 */
function sendOrderEmailNotifications($order_id, $isUpdate = false) {
    $db = getDB();
    $config = getSiteConfig();

    // 1. Fetch all necessary order and user data
    $stmt = $db->prepare("
        SELECT o.order_number, o.total_amount, u.first_name, u.last_name, u.email
        FROM orders o
        JOIN users u ON o.user_id = u.id
        WHERE o.id = ?
    ");
    $stmt->execute([$order_id]);
    $order = $stmt->fetch();
    if (!$order) {
        return false; // Order not found
    }

    // 2. Fetch order items and format them into a string
    $stmt = $db->prepare("
        SELECT mi.name, oi.quantity, oi.subtotal
        FROM order_items oi
        JOIN menu_items mi ON oi.menu_item_id = mi.id
        WHERE oi.order_id = ?
    ");
    $stmt->execute([$order_id]);
    $items = $stmt->fetchAll();

    $items_string = "";
    foreach ($items as $item) {
        $items_string .= "- " . $item['name'] . " x " . $item['quantity'] . " (" . formatPrice($item['subtotal']) . ")\n";
    }
    if (empty($items_string)) {
        $items_string = "No items in this order.";
    }

    $customer_email = $order['email'];
    $admin_email = $config['admin_email'] ?? null;
    $emailSentToCustomer = false;

    // --- 3. Send Email to Customer ---
    $customer_template_name = $isUpdate ? 'order_updated' : 'order_confirmation';
    $customer_template = getEmailTemplate($customer_template_name);

    if ($customer_template) {
        $placeholders = [
            'first_name' => $order['first_name'],
            'order_number' => $order['order_number'],
            'total_amount' => number_format($order['total_amount']),
            'event_date' => $config['event_date'] ?? 'N/A',
            'event_location' => $config['event_location'] ?? 'N/A',
            'order_items' => $items_string
        ];
        $subject = replacePlaceholders($customer_template['subject'], $placeholders);
        $body = replacePlaceholders($customer_template['body'], $placeholders);

        if (sendEmail($customer_email, $subject, $body)) {
            $emailSentToCustomer = true;
        }
    }

    // --- 4. Send Email to Admin ---
    if ($admin_email) {
        $admin_template_name = $isUpdate ? 'admin_order_updated_notification' : 'admin_order_notification';
        $admin_template = getEmailTemplate($admin_template_name);

        if ($admin_template) {
            $placeholders = [
                'order_number' => $order['order_number'],
                'customer_name' => $order['first_name'] . ' ' . $order['last_name'],
                'customer_email' => $order['email'],
                'total_amount' => number_format($order['total_amount']),
                'order_items' => $items_string
            ];
            $subject = replacePlaceholders($admin_template['subject'], $placeholders);
            $body = replacePlaceholders($admin_template['body'], $placeholders);

            sendEmail($admin_email, $subject, $body);
        }
    }

    return $emailSentToCustomer;
}
?>
